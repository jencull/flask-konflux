apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: export-pipeline-logs
  labels:
    app.kubernetes.io/managed-by: tekton
spec:
  # ... (params, results, workspaces are unchanged)
  params:
    - name: quay-repo
      type: string
      description: The base OCI repository path (e.g., quay.io/org/repo).
    # ... (other params unchanged)
    - name: artifact-credentials-secret
      type: string
      description: Name of the secret containing registry credentials.
  results:
    - name: LOG_ARTIFACT_TAG
      description: The specific tag generated for the log artifact.
  workspaces:
    - name: shared-data
      description: Workspace for log archiving and OCI artifact creation files. 
  volumes:
    - name: credentials-volume
      secret:
        secretName: $(params.artifact-credentials-secret)
  steps:
    - name: fetch-and-prepare-logs
      image: registry.redhat.io/openshift4/ose-cli:latest
      workingDir: $(workspaces.shared-data.path)
      env:
        # ... (env and script unchanged)
        - name: PR_NAME
          value: "$(params.pipeline-run-name)"
        - name: PR_NAMESPACE
          value: "$(params.namespace)"
        - name: HOME
          value: /tmp
      script: |
        #!/bin/bash
        set -euo pipefail
        microdnf install jq -y || dnf install jq -y
        LOG_FILENAME="all-logs.txt"
        ARCHIVE_FILENAME="logs.tar.gz"
        IMAGE_TAG="$(params.pipeline-run-name)-$(date +%Y%m%d%H%M%S)-logs"
        
        # ... (oc/kubectl logic unchanged) ...
        
        if [ -s "${LOG_FILENAME}" ]; then
            echo "Successfully fetched logs."
            tar -czf "${ARCHIVE_FILENAME}" "${LOG_FILENAME}"
            echo "Created compressed archive: ${ARCHIVE_FILENAME}"
            echo -n "${IMAGE_TAG}" > $(results.LOG_ARTIFACT_TAG.path)
            echo -n "${IMAGE_TAG}" > image-tag.txt
        else
            echo "Warning: Log file is empty. Skipping artifact creation."
            exit 0
        fi

    # NEW COMBINED STEP REPLACING read-tag-and-push AND push-log-artifact
    - name: secure-push-oci-direct
      image: quay.io/konflux-ci/tekton-integration-catalog/utils:latest
      workingDir: $(workspaces.shared-data.path)
      env:
        - name: OCI_REFERENCE_BASE
          value: $(params.quay-repo)
      script: |
        #!/bin/bash
        set -euo pipefail
        
        # 1. Read the generated tag
        IMAGE_TAG=$(cat image-tag.txt)
        
        # 2. Construct the final OCI Reference
        FULL_OCI_REF="${OCI_REFERENCE_BASE}:${IMAGE_TAG}"
        echo "Ready to push artifact to: ${FULL_OCI_REF}"
        
        # 3. Setup authentication using the mounted credentials volume
        if [ -f "/tekton/creds/.docker/config.json" ]; then
          export DOCKER_CONFIG="/tekton/creds/.docker"
        else
          echo "ERROR: Credentials not found at /tekton/creds/.docker/config.json"
          exit 1
        fi
        
        # 4. Push the artifact using the oras utility (which is in the utils image)
        oras push --no-tty \
          --artifact-type "application/vnd.logs.tar+gzip" \
          "${FULL_OCI_REF}" \
          "logs.tar.gz:application/vnd.logs.tar+gzip"
        
        echo "Successfully pushed log artifact to ${FULL_OCI_REF}"

      volumeMounts:
        - name: credentials-volume
          mountPath: /tekton/creds
